// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id             String       @id @default(cuid())
  name           String
  email          String?
  phone          String?
  address        String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  invoices       Invoice[]
  recurringInvoiceTemplates RecurringInvoiceTemplate[]

  // Payment method preferences
  stripeCustomerId        String?  // Stripe Customer ID (cus_xxx) for payment method storage
  preferredPaymentMethodId String? // Preferred Stripe PaymentMethod ID (pm_xxx)

  @@map("customers")
}

model Product {
  id             String       @id @default(cuid())
  name           String
  description    String?
  price          Float
  taxRate        Float        @default(0)
  unit           String       @default("piece")
  imageUrl       String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  invoiceItems   InvoiceItem[]

  @@map("products")
}

model Invoice {
  id             String        @id @default(cuid())
  invoiceNo      Int
  customer       Customer      @relation(fields: [customerId], references: [id])
  customerId     String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  status         String        @default("draft") // draft, sent, paid, overdue, cancelled
  issueDate      DateTime      @default(now())
  dueDate        DateTime
  notes          String?
  shareToken     String?       @unique
  emailSentCount Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  items          InvoiceItem[]
  payments       Payment[]
  emailLogs      EmailLog[]
  paymentPlan    PaymentPlan?
  
  // Payment reminder tracking
  lastReminderSentAt DateTime?  // Last time a reminder was sent
  reminderCount      Int         @default(0)  // Number of reminders sent
  markedOverdueAt    DateTime?  // When invoice was marked as overdue

  // Recurring invoice tracking
  recurringInvoiceTemplate   RecurringInvoiceTemplate? @relation(fields: [recurringTemplateId], references: [id], onDelete: SetNull)
  recurringTemplateId        String?

  @@unique([organizationId, invoiceNo])
  @@index([organizationId, createdAt])
  @@index([status, dueDate])  // For finding overdue invoices
  @@index([organizationId, status, dueDate])  // For reminder queries
  @@index([recurringTemplateId])
  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId   String
  product     Product @relation(fields: [productId], references: [id])
  productId   String
  description String
  quantity    Int
  price       Float
  taxRate     Float   @default(0)

  @@map("invoice_items")
}

model Payment {
  id        String   @id @default(cuid())
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId String
  amount    Float
  date      DateTime @default(now())
  method    String   // cash, bank_transfer, credit_card, paypal, stripe, etc.
  notes     String?
  createdAt DateTime @default(now())
  
  // Stripe payment fields
  stripePaymentIntentId String?  @unique  // Stripe PaymentIntent ID (pi_xxx)
  stripeChargeId        String?  @unique  // Stripe Charge ID (ch_xxx)
  stripeCustomerId      String?           // Stripe Customer ID (cus_xxx)
  stripeStatus          String?           // 'succeeded', 'pending', 'failed', 'canceled'

  // Payment retry fields
  retryCount            Int       @default(0)  // Number of retry attempts
  lastRetryAt           DateTime?              // Last retry attempt timestamp
  nextRetryAt          DateTime?                    // Next scheduled retry timestamp
  retryStatus           String?                 // 'pending', 'scheduled', 'exhausted', null
  maxRetries            Int       @default(3)  // Maximum retry attempts (default: 3)

  // Installment payment tracking
  installment   Installment? @relation(fields: [installmentId], references: [id], onDelete: SetNull)
  installmentId String?

  @@index([invoiceId, stripeStatus])
  @@index([stripeStatus, nextRetryAt])  // For finding payments ready to retry
  @@index([installmentId])
  @@map("payments")
}

model User {
  id            String   @id // Clerk user ID
  email         String?
  firstName     String?
  lastName      String?
  imageUrl      String?
  clerkUserId   String   @unique // Clerk user ID (same as id, but explicit)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  memberships   OrganizationMember[]

  @@map("users")
}

model Organization {
  id             String          @id // Clerk organization ID
  name           String
  slug           String?         @unique
  imageUrl       String?
  clerkOrgId     String          @unique // Clerk organization ID (same as id, but explicit)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  members        OrganizationMember[]
  customers      Customer[]
  products       Product[]
  invoices       Invoice[]
  invoiceCounter InvoiceCounter?
  recurringInvoiceTemplates RecurringInvoiceTemplate[]
  
  // Stripe Connect fields
  stripeAccountId      String?  @unique  // Connected Stripe account ID (acct_xxx)
  stripeAccountStatus  String?           // 'pending', 'active', 'restricted', 'disabled'
  stripeOnboardingComplete Boolean @default(false)
  stripeConnectEnabled    Boolean @default(false)
  stripeAccountEmail      String?        // Email from Stripe account
  country                 String?        // ISO country code (e.g., 'US', 'CA', 'GB') for Stripe Connect

  @@map("organizations")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           String       // admin, member, etc.
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([userId, organizationId])
  @@map("organization_members")
}

model EmailLog {
  id          String   @id @default(cuid())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId   String
  emailType   String   // 'invoice', 'payment_confirmation', or 'payment_reminder'
  recipient   String
  status      String   @default("sent") // 'sent' or 'failed'
  resendId    String?  // Resend email ID for tracking
  errorMessage String?
  sentAt      DateTime @default(now())
  events      EmailEvent[]

  @@map("email_logs")
  @@index([invoiceId])
  @@index([sentAt])
  @@index([resendId])
}

model EmailEvent {
  id          String   @id @default(cuid())
  emailLog    EmailLog @relation(fields: [emailLogId], references: [id], onDelete: Cascade)
  emailLogId  String
  eventType   String   // 'email.sent', 'email.delivered', 'email.opened', 'email.clicked', 'email.bounced', etc.
  metadata    String?  // JSON string for additional event data (clicked URL, bounce reason, etc.)
  occurredAt  DateTime @default(now())

  @@map("email_events")
  @@index([emailLogId])
  @@index([eventType])
  @@index([occurredAt])
}

model InvoiceCounter {
  organizationId String       @id
  lastInvoiceNo  Int          @default(0)
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("invoice_counters")
}

model PaymentPlan {
  id              String       @id @default(cuid())
  invoice         Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId       String       @unique
  totalAmount     Float        // Total amount to be paid in installments
  installmentCount Int         // Number of installments
  frequency       String       // 'weekly', 'biweekly', 'monthly', 'quarterly', 'custom'
  startDate       DateTime     // When first installment is due
  status          String       @default("active") // 'active', 'completed', 'cancelled'
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  installments    Installment[]

  @@map("payment_plans")
  @@index([status])
}

model Installment {
  id                String       @id @default(cuid())
  paymentPlan       PaymentPlan  @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)
  paymentPlanId     String
  installmentNumber Int          // 1, 2, 3, etc.
  amount            Float        // Amount due for this installment
  dueDate           DateTime     // When this installment is due
  status            String       @default("pending") // 'pending', 'paid', 'overdue', 'cancelled'
  paidAt            DateTime?    // When this installment was fully paid
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  payments          Payment[]    // Payments applied to this installment

  @@unique([paymentPlanId, installmentNumber])
  @@index([paymentPlanId, installmentNumber])
  @@index([status, dueDate]) // For finding overdue installments
  @@map("installments")
}

model RecurringInvoiceTemplate {
  id                String       @id @default(cuid())
  name              String       // Template name (e.g., "Monthly Subscription - Customer X")
  organizationId   String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customerId       String
  customer          Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  // Recurrence settings
  frequency         String       // 'daily', 'weekly', 'biweekly', 'monthly', 'quarterly', 'yearly', 'custom'
  interval          Int          @default(1) // For custom frequency (e.g., every 2 months)
  startDate         DateTime     // When to start generating invoices
  endDate           DateTime?    // Optional end date (null = never ends)
  nextGenerationDate DateTime   // Next date when invoice should be generated
  
  // Invoice template data (stored as JSON)
  templateItems     String       // JSON array of invoice items
  templateNotes     String?      // Notes to include in each invoice
  daysUntilDue      Int          @default(30) // Days from issue date to due date
  
  // Status and tracking
  status            String       @default("active") // 'active', 'paused', 'cancelled', 'completed'
  autoSendEmail     Boolean      @default(true) // Automatically send email when invoice is generated
  totalGenerated    Int          @default(0) // Count of invoices generated
  lastGeneratedAt   DateTime?    // Last time an invoice was generated
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  invoices          Invoice[]    // Invoices generated from this template

  @@index([organizationId, status])
  @@index([status, nextGenerationDate]) // For finding templates ready to generate
  @@index([customerId])
  @@map("recurring_invoice_templates")
}

