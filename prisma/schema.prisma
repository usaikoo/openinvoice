// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id                        String                     @id @default(cuid())
  name                      String
  email                     String?
  phone                     String?
  address                   String?
  organizationId            String
  organization              Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  invoices                  Invoice[]
  recurringInvoiceTemplates RecurringInvoiceTemplate[]

  // Payment method preferences
  stripeCustomerId         String? // Stripe Customer ID (cus_xxx) for payment method storage
  preferredPaymentMethodId String? // Preferred Stripe PaymentMethod ID (pm_xxx)

  // Tax exemption fields
  taxExempt          Boolean @default(false) // Whether customer is tax exempt
  taxExemptionReason String? // Reason for tax exemption (e.g., "nonprofit", "export")
  taxId              String? // Customer's tax ID number (for tax reporting)
  
  // Address fields for tax calculation (TaxJar, etc.)
  // Note: address field above is a free-form string. These fields provide structured data.
  addressLine1       String? // Street address line 1
  addressLine2       String? // Street address line 2
  city               String? // City
  state              String? // State/Province code (e.g., CA, NY, ON)
  postalCode         String? // ZIP/Postal code
  country            String? // ISO country code (e.g., US, CA, GB)

  @@map("customers")
}

model Product {
  id             String        @id @default(cuid())
  name           String
  description    String?
  price          Float
  taxRate        Float         @default(0)
  unit           String        @default("piece")
  imageUrl       String?
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  invoiceItems   InvoiceItem[]

  @@map("products")
}

model Invoice {
  id             String        @id @default(cuid())
  invoiceNo      Int
  customer       Customer      @relation(fields: [customerId], references: [id])
  customerId     String
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  status         String        @default("draft") // draft, sent, paid, overdue, cancelled
  issueDate      DateTime      @default(now())
  dueDate        DateTime
  notes          String?
  shareToken     String?       @unique
  emailSentCount Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  items          InvoiceItem[]
  payments       Payment[]
  emailLogs      EmailLog[]
  smsLogs        SmsLog[]
  paymentPlan    PaymentPlan?

  // Payment reminder tracking
  lastReminderSentAt DateTime? // Last time a reminder was sent
  reminderCount      Int       @default(0) // Number of reminders sent
  markedOverdueAt    DateTime? // When invoice was marked as overdue

  // Recurring invoice tracking
  recurringInvoiceTemplate RecurringInvoiceTemplate? @relation(fields: [recurringTemplateId], references: [id], onDelete: SetNull)
  recurringTemplateId      String?
  usageRecords             UsageRecord[] // Usage records billed on this invoice

  // Invoice template
  invoiceTemplate InvoiceTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  templateId      String?

  // Currency
  currency String? // ISO 4217 currency code (e.g., USD, EUR, GBP). If null, uses organization defaultCurrency

  // Stripe Tax fields (deprecated - kept for backward compatibility)
  stripeTaxEnabled       Boolean @default(false) // Whether Stripe Tax was used for this invoice
  stripeTaxCalculationId String? // Stripe Tax Calculation ID (taxcalc_xxx)
  totalTaxAmount         Float? // Total tax amount calculated by Stripe Tax (in addition to manual taxRate)
  taxBreakdown           String? // JSON string containing detailed tax breakdown from Stripe

  // Custom Tax System
  taxCalculationMethod String? // "manual" | "profile" | "override" | "taxjar" - how tax was calculated
  taxProfileId         String? // Tax profile used (if taxCalculationMethod is "profile")
  taxProfile           TaxProfile?  @relation(fields: [taxProfileId], references: [id], onDelete: SetNull)
  invoiceTaxes         InvoiceTax[] // Tax breakdown for this invoice
  
  // TaxJar fields
  taxJarTransactionId String? // TaxJar transaction ID for this invoice
  taxJarTransactionReference String? // TaxJar transaction reference

  @@unique([organizationId, invoiceNo])
  @@index([organizationId, createdAt])
  @@index([status, dueDate]) // For finding overdue invoices
  @@index([organizationId, status, dueDate]) // For reminder queries
  @@index([recurringTemplateId])
  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId   String
  product     Product @relation(fields: [productId], references: [id])
  productId   String
  description String
  quantity    Int
  price       Float
  taxRate     Float   @default(0)

  // Stripe Tax fields (for items with automatic tax calculation)
  stripeTaxAmount Float? // Tax amount calculated by Stripe Tax for this item
  stripeTaxRate   Float? // Effective tax rate from Stripe Tax

  @@map("invoice_items")
}

model Payment {
  id        String   @id @default(cuid())
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId String
  amount    Float
  date      DateTime @default(now())
  method    String // cash, bank_transfer, credit_card, paypal, stripe, etc.
  notes     String?
  createdAt DateTime @default(now())

  // Stripe payment fields
  stripePaymentIntentId String? @unique // Stripe PaymentIntent ID (pi_xxx)
  stripeChargeId        String? @unique // Stripe Charge ID (ch_xxx)
  stripeCustomerId      String? // Stripe Customer ID (cus_xxx)
  stripeStatus          String? // 'succeeded', 'pending', 'failed', 'canceled'

  // Payment retry fields
  retryCount  Int       @default(0) // Number of retry attempts
  lastRetryAt DateTime? // Last retry attempt timestamp
  nextRetryAt DateTime? // Next scheduled retry timestamp
  retryStatus String? // 'pending', 'scheduled', 'exhausted', null
  maxRetries  Int       @default(3) // Maximum retry attempts (default: 3)

  // Installment payment tracking
  installment   Installment? @relation(fields: [installmentId], references: [id], onDelete: SetNull)
  installmentId String?

  @@index([invoiceId, stripeStatus])
  @@index([stripeStatus, nextRetryAt]) // For finding payments ready to retry
  @@index([installmentId])
  @@map("payments")
}

model User {
  id          String               @id // Clerk user ID
  email       String?
  firstName   String?
  lastName    String?
  imageUrl    String?
  clerkUserId String               @unique // Clerk user ID (same as id, but explicit)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  memberships OrganizationMember[]

  @@map("users")
}

model Organization {
  id                        String                     @id // Clerk organization ID
  name                      String
  slug                      String?                    @unique
  imageUrl                  String?
  clerkOrgId                String                     @unique // Clerk organization ID (same as id, but explicit)
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  members                   OrganizationMember[]
  customers                 Customer[]
  products                  Product[]
  invoices                  Invoice[]
  invoiceCounter            InvoiceCounter?
  recurringInvoiceTemplates RecurringInvoiceTemplate[]

  // Stripe Connect fields
  stripeAccountId          String? @unique // Connected Stripe account ID (acct_xxx)
  stripeAccountStatus      String? // 'pending', 'active', 'restricted', 'disabled'
  stripeOnboardingComplete Boolean @default(false)
  stripeConnectEnabled     Boolean @default(false)
  stripeAccountEmail       String? // Email from Stripe account
  country                  String? // ISO country code (e.g., 'US', 'CA', 'GB') for Stripe Connect

  // Branding fields
  logoUrl        String? // Company logo URL
  primaryColor   String? // Primary brand color (hex)
  secondaryColor String? // Secondary brand color (hex)
  fontFamily     String? // Font family for invoices
  companyAddress String? // Company address
  companyPhone   String? // Company phone number
  companyEmail   String? // Company email
  companyWebsite String? // Company website URL
  footerText     String? // Footer text for invoices

  // Currency settings
  defaultCurrency String @default("USD") // ISO 4217 currency code (e.g., USD, EUR, GBP)

  // Stripe Tax settings (deprecated - kept for backward compatibility)
  stripeTaxEnabled      Boolean @default(false) // Enable automatic tax calculation via Stripe Tax
  taxRegistrationNumber String? // Tax registration number (e.g., VAT number, GST number)

  // Custom Tax System
  taxProfiles         TaxProfile[] // Tax profiles for this organization
  defaultTaxProfileId String? // Default tax profile ID
  defaultTaxProfile   TaxProfile?  @relation("DefaultTaxProfile", fields: [defaultTaxProfileId], references: [id], onDelete: SetNull)

  // TaxJar Integration
  taxJarEnabled Boolean @default(false) // Enable automatic tax calculation via TaxJar
  taxJarApiKey  String? // TaxJar API key (if not set, uses TAXJAR_API_KEY from env)
  taxJarNexusRegions String? // JSON array of nexus regions for TaxJar (e.g., [{"country": "US", "state": "CA"}])

  invoiceTemplates InvoiceTemplate[] // Invoice templates

  // Email Configuration
  emailProvider String? // 'resend' or 'smtp' - which email provider to use
  
  // Resend Configuration
  resendApiKey  String? // Resend API key (if not set, uses RESEND_API_KEY from env)
  resendFromEmail String? // From email address (if not set, uses RESEND_FROM_EMAIL from env)
  resendFromName  String? // From name (if not set, uses RESEND_FROM_NAME from env)

  // SMTP Configuration
  smtpHost String? // SMTP server hostname (e.g., smtp.gmail.com, smtp.sendgrid.net)
  smtpPort Int? // SMTP server port (e.g., 587, 465, 25)
  smtpSecure Boolean @default(false) // Use TLS/SSL (true for port 465, false for port 587)
  smtpUsername String? // SMTP username/email
  smtpPassword String? // SMTP password or app password
  smtpFromEmail String? // From email address for SMTP
  smtpFromName String? // From name for SMTP

  // SMS Configuration (Twilio)
  twilioAccountSid String? // Twilio Account SID (if not set, uses TWILIO_ACCOUNT_SID from env)
  twilioAuthToken  String? // Twilio Auth Token (if not set, uses TWILIO_AUTH_TOKEN from env)
  twilioFromNumber String? // Twilio From Phone Number (if not set, uses TWILIO_FROM_NUMBER from env)

  @@map("organizations")
}

model OrganizationMember {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           String // admin, member, etc.
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([userId, organizationId])
  @@map("organization_members")
}

model EmailLog {
  id           String       @id @default(cuid())
  invoice      Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId    String
  emailType    String // 'invoice', 'payment_confirmation', or 'payment_reminder'
  recipient    String
  status       String       @default("sent") // 'sent' or 'failed'
  resendId     String? // Resend email ID for tracking
  errorMessage String?
  sentAt       DateTime     @default(now())
  events       EmailEvent[]

  @@index([invoiceId])
  @@index([sentAt])
  @@index([resendId])
  @@map("email_logs")
}

model SmsLog {
  id           String   @id @default(cuid())
  invoice      Invoice? @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId    String?
  smsType      String   // 'invoice', 'payment_confirmation', or 'payment_reminder'
  recipient    String   // Phone number
  message      String   // SMS message content
  status       String   @default("sent") // 'sent', 'delivered', 'failed', 'pending'
  twilioSid    String?  // Twilio Message SID
  errorMessage String?
  sentAt       DateTime @default(now())
  deliveredAt DateTime?

  @@index([invoiceId])
  @@index([recipient])
  @@index([status])
  @@index([sentAt])
  @@map("sms_logs")
}

model EmailEvent {
  id         String   @id @default(cuid())
  emailLog   EmailLog @relation(fields: [emailLogId], references: [id], onDelete: Cascade)
  emailLogId String
  eventType  String // 'email.sent', 'email.delivered', 'email.opened', 'email.clicked', 'email.bounced', etc.
  metadata   String? // JSON string for additional event data (clicked URL, bounce reason, etc.)
  occurredAt DateTime @default(now())

  @@index([emailLogId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("email_events")
}

model InvoiceCounter {
  organizationId String       @id
  lastInvoiceNo  Int          @default(0)
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("invoice_counters")
}

model PaymentPlan {
  id               String        @id @default(cuid())
  invoice          Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId        String        @unique
  totalAmount      Float // Total amount to be paid in installments
  installmentCount Int // Number of installments
  frequency        String // 'weekly', 'biweekly', 'monthly', 'quarterly', 'custom'
  startDate        DateTime // When first installment is due
  status           String        @default("active") // 'active', 'completed', 'cancelled'
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  installments     Installment[]

  @@index([status])
  @@map("payment_plans")
}

model Installment {
  id                String      @id @default(cuid())
  paymentPlan       PaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)
  paymentPlanId     String
  installmentNumber Int // 1, 2, 3, etc.
  amount            Float // Amount due for this installment
  dueDate           DateTime // When this installment is due
  status            String      @default("pending") // 'pending', 'paid', 'overdue', 'cancelled'
  paidAt            DateTime? // When this installment was fully paid
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  payments          Payment[] // Payments applied to this installment

  @@unique([paymentPlanId, installmentNumber])
  @@index([paymentPlanId, installmentNumber])
  @@index([status, dueDate]) // For finding overdue installments
  @@map("installments")
}

model RecurringInvoiceTemplate {
  id             String       @id @default(cuid())
  name           String // Template name (e.g., "Monthly Subscription - Customer X")
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customerId     String
  customer       Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Recurrence settings
  frequency          String // 'daily', 'weekly', 'biweekly', 'monthly', 'quarterly', 'yearly', 'custom'
  interval           Int       @default(1) // For custom frequency (e.g., every 2 months)
  startDate          DateTime // When to start generating invoices
  endDate            DateTime? // Optional end date (null = never ends)
  nextGenerationDate DateTime // Next date when invoice should be generated

  // Invoice template data (stored as JSON)
  templateItems String // JSON array of invoice items
  templateNotes String? // Notes to include in each invoice
  daysUntilDue  Int     @default(30) // Days from issue date to due date

  // Status and tracking
  status          String    @default("active") // 'active', 'paused', 'cancelled', 'completed'
  autoSendEmail   Boolean   @default(true) // Automatically send email when invoice is generated
  totalGenerated  Int       @default(0) // Count of invoices generated
  lastGeneratedAt DateTime? // Last time an invoice was generated

  // Usage-based billing
  isUsageBased Boolean @default(false) // Whether this template uses usage-based billing
  usageUnit    String? // Unit of measurement for usage (e.g., "GB", "API calls", "hours")

  // Currency
  currency String? // ISO 4217 currency code (e.g., USD, EUR, GBP). If null, uses organization defaultCurrency

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  invoices     Invoice[] // Invoices generated from this template
  usageRecords UsageRecord[] // Usage records for this template

  @@index([organizationId, status])
  @@index([status, nextGenerationDate]) // For finding templates ready to generate
  @@index([customerId])
  @@map("recurring_invoice_templates")
}

model UsageRecord {
  id                  String                   @id @default(cuid())
  recurringTemplate   RecurringInvoiceTemplate @relation(fields: [recurringTemplateId], references: [id], onDelete: Cascade)
  recurringTemplateId String
  invoice             Invoice?                 @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  invoiceId           String?

  // Usage period
  periodStart DateTime // Start of the billing period
  periodEnd   DateTime // End of the billing period

  // Usage data
  quantity Float // Usage quantity (e.g., 100 GB, 5000 API calls)
  metadata String? // JSON string for additional usage metadata

  // Tracking
  recordedAt DateTime @default(now()) // When usage was recorded
  recordedBy String? // User ID who recorded the usage (optional)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recurringTemplateId, periodStart, periodEnd]) // For finding usage in a period
  @@index([invoiceId])
  @@index([recurringTemplateId, recordedAt])
  @@map("usage_records")
}

model InvoiceTemplate {
  id             String       @id @default(cuid())
  name           String // Template name (e.g., "Modern", "Classic", "Minimal")
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Template configuration (stored as JSON)
  layout         String? // Layout type: 'standard', 'compact', 'detailed'
  headerTemplate String? // Custom header HTML/template
  footerTemplate String? // Custom footer HTML/template
  styles         String? // Custom CSS styles (JSON)

  // Template settings
  isDefault Boolean @default(false) // Default template for organization
  isActive  Boolean @default(true) // Whether template is active

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  invoices  Invoice[] // Invoices using this template

  @@index([organizationId, isDefault])
  @@index([organizationId, isActive])
  @@map("invoice_templates")
}

model TaxProfile {
  id                     String         @id @default(cuid())
  organizationId         String
  organization           Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name                   String // e.g., "Canada - Quebec", "US - California"
  countryCode            String // ISO country code (CA, US, FR, etc.)
  regionCode             String? // State/Province code (QC, CA, etc.)
  isDefault              Boolean        @default(false)
  taxRules               TaxRule[]
  invoices               Invoice[] // Invoices using this profile
  organizationsAsDefault Organization[] @relation("DefaultTaxProfile") // Organizations that use this as default
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt

  @@index([organizationId])
  @@index([organizationId, isDefault])
  @@map("tax_profiles")
}

model TaxRule {
  id           String     @id @default(cuid())
  taxProfileId String
  taxProfile   TaxProfile @relation(fields: [taxProfileId], references: [id], onDelete: Cascade)
  name         String // e.g., "GST", "PST", "VAT", "State Tax"
  rate         Float // Percentage (5.0 = 5%)
  authority    String? // "federal", "state", "provincial", "vat", "local"
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([taxProfileId])
  @@map("tax_rules")
}

model InvoiceTax {
  id         String   @id @default(cuid())
  invoiceId  String
  invoice    Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  name       String // Tax name
  rate       Float // Tax rate percentage
  amount     Float // Calculated tax amount
  authority  String? // Tax authority type
  isOverride Boolean  @default(false) // If true, overrides org defaults
  createdAt  DateTime @default(now())

  @@index([invoiceId])
  @@map("invoice_taxes")
}
